name: æ¯æ—¥èŠ‚å‡æ—¥å€’è®¡æ—¶ä¸æ–°é—»

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´ 8:00 (UTC 0:00)
  schedule:
    - cron: '0 0 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•
  workflow_dispatch:

jobs:
  daily-notification:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        # å¢åŠ  feedparser ç”¨äºè§£æ RSS
        run: pip install requests pytz feedparser

      - name: è®¡ç®—å€’è®¡æ—¶ã€è·å–æ–°é—»å¹¶å‘é€é€šçŸ¥
        env:
          WECHAT_KEY: ${{ secrets.WECHAT_KEY }}
        run: |
          # åˆ›å»º Python è„šæœ¬
          cat <<EOF > holiday_bot.py
          import datetime
          import pytz
          import requests
          import os
          import json
          import feedparser # å¯¼å…¥ feedparser

          # 1. è·å–åŒ—äº¬æ—¶é—´
          tz = pytz.timezone('Asia/Shanghai')
          now = datetime.datetime.now(tz)
          today = now.date()

          # 2. æ˜ŸæœŸè½¬æ¢
          week_map = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"]
          weekday = week_map[today.weekday()]

          # -------------------------------------------------------
          # 3. èŠ‚å‡æ—¥åˆ—è¡¨ (è¯·æ ¹æ®å¹´ä»½æ‰‹åŠ¨æ›´æ–°è¿™é‡Œçš„æ—¥æœŸ)
          # æ ¼å¼: ("èŠ‚æ—¥åç§°", "YYYY-MM-DD")
          # -------------------------------------------------------
          holidays = [
              ("å…ƒæ—¦", "2025-01-01"),
              ("æ˜¥èŠ‚", "2025-01-29"), # 2025å¹´æ˜¥èŠ‚
              ("æ¸…æ˜èŠ‚", "2025-04-04"),
              ("åŠ³åŠ¨èŠ‚", "2025-05-01"),
              ("ç«¯åˆèŠ‚", "2025-05-31"),
              ("ä¸­ç§‹èŠ‚", "2025-10-06"),
              ("å›½åº†èŠ‚", "2025-10-01"),
              ("2026å…ƒæ—¦", "2026-01-01"),
              ("2026æ˜¥èŠ‚", "2026-02-17") 
          ]
          
          # -------------------------------------------------------

          # å¯»æ‰¾æœ€è¿‘çš„ä¸€ä¸ªèŠ‚æ—¥
          next_holiday_name = ""
          next_holiday_days = 999
          
          # ä¸“é—¨å¯»æ‰¾æ˜¥èŠ‚
          cny_days = -1
          
          for name, date_str in holidays:
              h_date = datetime.datetime.strptime(date_str, "%Y-%m-%d").date()
              diff = (h_date - today).days
              
              # åªæœ‰æœªæ¥çš„èŠ‚æ—¥æ‰è®¡ç®—
              if diff >= 0:
                  # æ‰¾æœ€è¿‘çš„èŠ‚æ—¥
                  if diff < next_holiday_days:
                      next_holiday_days = diff
                      next_holiday_name = name
                  
                  # å¦‚æœæ˜¯å½“å‰å¹´ä»½æœ€è¿‘çš„ä¸€ä¸ªæ˜¥èŠ‚ (é€»è¾‘ç®€å•åˆ¤æ–­åŒ…å«"æ˜¥èŠ‚"å­—æ ·)
                  if "æ˜¥èŠ‚" in name and (cny_days == -1 or h_date < datetime.datetime.strptime(holidays[holidays.index((name, date_str))-1][1], "%Y-%m-%d").date().replace(year=h_date.year) if "æ˜¥èŠ‚" in holidays[holidays.index((name, date_str))-1][0] else False):
                      cny_days = diff
                      
          # 4. è·å–æ¯æ—¥æ–°é—» (é€šè¿‡ RSS Feed)
          news_headlines = []
          try:
              # äººæ°‘ç½‘è¦é—»å¿«è®¯ RSS Feed
              rss_url = "http://www.people.com.cn/rss/ywkx.xml" 
              feed = feedparser.parse(rss_url)
              
              if feed.entries:
                  for i, entry in enumerate(feed.entries[:10]): # è·å–å‰10æ¡æ–°é—»
                      news_headlines.append(f"{i+1}. {entry.title}")
              else:
                  news_headlines.append("æœªèƒ½è·å–åˆ°çƒ­é—¨æ–°é—»ã€‚")
          except Exception as e:
              news_headlines.append(f"è·å–æ–°é—»æ—¶å‘ç”Ÿé”™è¯¯: {e}")
          
          # å¦‚æœæƒ³ä½¿ç”¨æ–°é—» API (ä¾‹å¦‚èšåˆæ•°æ®ã€ä»Šæ—¥å¤´æ¡ç­‰)ï¼Œéœ€è¦æ›¿æ¢ä¸Šè¿° RSS éƒ¨åˆ†ï¼Œå¹¶é€šå¸¸éœ€è¦ API Key
          # ä¾‹å¦‚ (ä¼ªä»£ç ):
          # news_api_key = "YOUR_NEWS_API_KEY" # éœ€è¦åœ¨ GitHub Secrets ä¸­è®¾ç½®
          # news_api_url = f"https://api.some-news-service.com/top-headlines?apiKey={news_api_key}&country=cn"
          # response = requests.get(news_api_url)
          # data = response.json()
          # for article in data.get("articles", [])[:10]:
          #     news_headlines.append(f"- {article['title']}")


          # 5. æ„å»ºæ¶ˆæ¯å†…å®¹
          content = f"ğŸŒ æ—©å®‰ï¼æ‰“å·¥äººï¼\n"
          content += f"ğŸ“… ä»Šå¤©æ˜¯ï¼š{today} {weekday}\n"
          content += f"------------------------\n"
          
          # æœ€è¿‘çš„èŠ‚æ—¥
          if next_holiday_name:
              if next_holiday_days == 0:
                  content += f"ğŸ‰ ä»Šå¤©å°±æ˜¯ã€{next_holiday_name}ã€‘ï¼èŠ‚æ—¥å¿«ä¹ï¼\n"
              else:
                  content += f"â³ è·ç¦»ã€{next_holiday_name}ã€‘è¿˜æœ‰ {next_holiday_days} å¤©\n"
          
          # ç‰¹åˆ«å¼ºè°ƒæ˜¥èŠ‚ (å¦‚æœæœ€è¿‘çš„èŠ‚æ—¥ä¸æ˜¯æ˜¥èŠ‚ï¼Œåˆ™é¢å¤–æ˜¾ç¤ºæ˜¥èŠ‚)
          if cny_days != -1 and ("æ˜¥èŠ‚" not in next_holiday_name or next_holiday_days > 0): # é¿å…é‡å¤æ˜¾ç¤ºä»Šå¤©çš„æ˜¥èŠ‚
             content += f"ğŸ§¨ è·ç¦»ã€æ˜¥èŠ‚ã€‘è¿˜æœ‰ {cny_days} å¤©\n"
          
          content += f"------------------------\n"
          content += f"ğŸ“° ä»Šæ—¥çƒ­é—¨æ–°é—»ï¼š\n"
          if news_headlines:
              content += "\n".join(news_headlines)
          else:
              content += "æš‚æ— æ–°é—»æ›´æ–°ã€‚"
          
          content += f"\n------------------------\n"
          content += f"ğŸ’ª æ—¢ç„¶ä¸Šäº†è´¼èˆ¹ï¼Œå°±åšä¸€ä¸ªå¿«ä¹çš„æµ·ç›—ï¼"

          print("å‘é€çš„æ¶ˆæ¯å†…å®¹:\n" + content)

          # 6. å‘é€ä¼ä¸šå¾®ä¿¡
          webhook_key = os.environ.get("WECHAT_KEY")
          if not webhook_key:
              print("é”™è¯¯: æœªæ‰¾åˆ° WECHAT_KEY secret")
              exit(1)
              
          url = f"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key={webhook_key}"
          headers = {"Content-Type": "application/json"}
          data = {
              "msgtype": "text",
              "text": {
                  "content": content
              }
          }
          
          response = requests.post(url, headers=headers, json=data)
          print("å“åº”çŠ¶æ€:", response.text)
          EOF

          # è¿è¡Œè„šæœ¬
          python holiday_bot.py
