name: æ¯æ—¥èŠ‚å‡æ—¥å€’è®¡æ—¶

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´ 8:00 (UTC 0:00)
  schedule:
    - cron: '0 0 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘æµ‹è¯•
  workflow_dispatch:

jobs:
  daily-notification:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests pytz

      - name: è®¡ç®—å€’è®¡æ—¶å¹¶å‘é€é€šçŸ¥
        env:
          WECHAT_KEY: ${{ secrets.WECHAT_KEY }}
        run: |
          # åˆ›å»º Python è„šæœ¬
          cat <<EOF > holiday_bot.py
          import datetime
          import pytz
          import requests
          import os
          import json

          # 1. è·å–åŒ—äº¬æ—¶é—´
          tz = pytz.timezone('Asia/Shanghai')
          now = datetime.datetime.now(tz)
          today = now.date()

          # 2. æ˜ŸæœŸè½¬æ¢
          week_map = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"]
          weekday = week_map[today.weekday()]

          # -------------------------------------------------------
          # 3. èŠ‚å‡æ—¥åˆ—è¡¨ (è¯·æ ¹æ®å¹´ä»½æ‰‹åŠ¨æ›´æ–°è¿™é‡Œçš„æ—¥æœŸ)
          # æ ¼å¼: ("èŠ‚æ—¥åç§°", "YYYY-MM-DD")
          # -------------------------------------------------------
          holidays = [
              ("å…ƒæ—¦", "2025-01-01"),
              ("æ˜¥èŠ‚", "2025-01-29"), # 2025å¹´æ˜¥èŠ‚
              ("æ¸…æ˜èŠ‚", "2025-04-04"),
              ("åŠ³åŠ¨èŠ‚", "2025-05-01"),
              ("ç«¯åˆèŠ‚", "2025-05-31"),
              ("ä¸­ç§‹èŠ‚", "2025-10-06"),
              ("å›½åº†èŠ‚", "2025-10-01"),
              ("2026å…ƒæ—¦", "2026-01-01"),
              ("2026æ˜¥èŠ‚", "2026-02-17") 
          ]
          
          # -------------------------------------------------------

          # å¯»æ‰¾æœ€è¿‘çš„ä¸€ä¸ªèŠ‚æ—¥
          next_holiday_name = ""
          next_holiday_days = 999
          
          # ä¸“é—¨å¯»æ‰¾æ˜¥èŠ‚
          cny_days = -1
          
          for name, date_str in holidays:
              h_date = datetime.datetime.strptime(date_str, "%Y-%m-%d").date()
              diff = (h_date - today).days
              
              # åªæœ‰æœªæ¥çš„èŠ‚æ—¥æ‰è®¡ç®—
              if diff >= 0:
                  # æ‰¾æœ€è¿‘çš„èŠ‚æ—¥
                  if diff < next_holiday_days:
                      next_holiday_days = diff
                      next_holiday_name = name
                  
                  # å¦‚æœæ˜¯å½“å‰å¹´ä»½æœ€è¿‘çš„ä¸€ä¸ªæ˜¥èŠ‚ (é€»è¾‘ç®€å•åˆ¤æ–­åŒ…å«"æ˜¥èŠ‚"å­—æ ·)
                  if "æ˜¥èŠ‚" in name and cny_days == -1:
                      cny_days = diff

          # 4. æ„å»ºæ¶ˆæ¯å†…å®¹
          content = f"ğŸŒ æ—©å®‰ï¼æ‰“å·¥äººï¼\n"
          content += f"ğŸ“… ä»Šå¤©æ˜¯ï¼š{today} {weekday}\n"
          content += f"------------------------\n"
          
          # æœ€è¿‘çš„èŠ‚æ—¥
          if next_holiday_name:
              if next_holiday_days == 0:
                  content += f"ğŸ‰ ä»Šå¤©å°±æ˜¯ã€{next_holiday_name}ã€‘ï¼èŠ‚æ—¥å¿«ä¹ï¼\n"
              else:
                  content += f"â³ è·ç¦»ã€{next_holiday_name}ã€‘è¿˜æœ‰ {next_holiday_days} å¤©\n"
          
          # ç‰¹åˆ«å¼ºè°ƒæ˜¥èŠ‚ (å¦‚æœæœ€è¿‘çš„èŠ‚æ—¥ä¸æ˜¯æ˜¥èŠ‚ï¼Œåˆ™é¢å¤–æ˜¾ç¤ºæ˜¥èŠ‚)
          if cny_days != -1 and "æ˜¥èŠ‚" not in next_holiday_name:
             content += f"ğŸ§¨ è·ç¦»ã€æ˜¥èŠ‚ã€‘è¿˜æœ‰ {cny_days} å¤©\n"
          
          content += f"------------------------\n"
          content += f"ğŸ’ª æ—¢ç„¶ä¸Šäº†è´¼èˆ¹ï¼Œå°±åšä¸€ä¸ªå¿«ä¹çš„æµ·ç›—ï¼"

          print("å‘é€çš„æ¶ˆæ¯å†…å®¹:\n" + content)

          # 5. å‘é€ä¼ä¸šå¾®ä¿¡
          webhook_key = os.environ.get("WECHAT_KEY")
          if not webhook_key:
              print("é”™è¯¯: æœªæ‰¾åˆ° WECHAT_KEY secret")
              exit(1)
              
          url = f"https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key={webhook_key}"
          headers = {"Content-Type": "application/json"}
          data = {
              "msgtype": "text",
              "text": {
                  "content": content
              }
          }
          
          response = requests.post(url, headers=headers, json=data)
          print("å“åº”çŠ¶æ€:", response.text)
          EOF

          # è¿è¡Œè„šæœ¬
          python holiday_bot.py
